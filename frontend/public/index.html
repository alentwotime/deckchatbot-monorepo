<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Decking Chatbot</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css">
</head>
<body>
  <div class="d-flex justify-content-end mb-3 gap-2">
    <button id="themeToggle" class="btn btn-secondary btn-sm">Toggle Theme</button>
    <button id="styleSwitch" class="btn btn-outline-secondary btn-sm">Switch Style</button>
  </div>

  <p class="note" role="status" aria-live="polite">
    To analyze deck drawings, upload a general image with <strong>Upload Image</strong> or digitalize a specific drawing below. Image uploads do not work through chat.
  </p>

  <div id="chat">
    <h2>Decking Chatbot</h2>
    <div id="chatLog" class="mb-3 border p-2 chat-log"></div>
    <form id="chatForm" autocomplete="off">
      <div id="inputArea" class="input-group">
        <input type="text" id="messageInput" placeholder="Type your message..." class="form-control">
        <button id="sendBtn" type="submit" class="btn btn-success">Send</button>
      </div>
    </form>
    <div class="mt-4">
      <label for="fileInput" class="form-label">Upload a photo:</label>
      <input type="file" id="fileInput" accept="image/*" class="form-control w-auto d-inline">
      <button id="uploadButton" type="button" class="btn btn-primary ms-1">Upload Image</button>
    </div>
    <div class="mt-3">
      <label for="drawingInput" class="form-label">Digitalize deck drawing:</label>
      <input type="file" id="drawingInput" accept="image/*" class="form-control w-auto d-inline">
      <button id="digitalizeBtn" type="button" class="btn btn-primary ms-1">Digitalize Drawing</button>
    </div>
    <div id="uploadLoader" class="spinner-border text-primary d-none mt-3" role="status">
      <span class="visually-hidden">Uploading...</span>
    </div>
    <div class="text-center mt-3">
      <img id="preview" class="img-fluid d-none" alt="Preview">
    </div>
    <div id="svgPreview" class="text-center my-4"></div>
  </div>

  <div id="deckCalc" class="mt-5">
    <h3>Deck Layout & Material Calculator</h3>
    <form id="deckForm" class="row gy-2 gx-3 align-items-center">
      <div class="col-auto">
        <label for="shape" class="visually-hidden">Shape</label>
        <select id="shape" class="form-select">
          <option value="rectangle" selected>Rectangle</option>
          <option value="lshape">L-Shape</option>
          <option value="octagon">Octagon</option>
        </select>
      </div>
      <div class="col-auto shape-field shape-rectangle">
        <input type="number" id="length" class="form-control" placeholder="Length (ft)">
      </div>
      <div class="col-auto shape-field shape-rectangle">
        <input type="number" id="width" class="form-control" placeholder="Width (ft)">
      </div>
      <fieldset class="col-auto border rounded p-2 lshape-dimensions hidden">
        <legend class="float-none w-auto px-2 fs-6 mb-1">L-Shape Deck Dimensions</legend>
        <input type="number" id="length1" class="form-control mb-1" placeholder="Section 1 Length (ft)">
        <input type="number" id="width1" class="form-control mb-1" placeholder="Section 1 Width (ft)">
        <input type="number" id="length2" class="form-control mb-1" placeholder="Section 2 Length (ft)">
        <input type="number" id="width2" class="form-control" placeholder="Section 2 Width (ft)">
      </fieldset>
      <div class="col-auto shape-field shape-octagon">
        <input type="number" id="side" class="form-control" placeholder="Side Length (ft)">
      </div>
      <div class="col-auto">
        <label for="orientation" class="visually-hidden">Orientation</label>
        <select id="orientation" class="form-select">
          <option value="horizontal" selected>Horizontal</option>
          <option value="vertical">Vertical</option>
        </select>
      </div>
      <div class="col-auto">
        <select id="attachment" class="form-select" title="Attachment Type">
          <option value="attached" selected>Attached</option>
          <option value="freestanding">Freestanding</option>
        </select>
      </div>
      <div class="col-auto">
        <input type="number" id="height" class="form-control" placeholder="Height (ft)">
      </div>
      <div class="col-auto">
        <input class="form-check-input" type="checkbox" id="railings" checked>
        <label class="form-check-label" for="railings">Railings</label>
      </div>
      <div class="col-auto">
        <input class="form-check-input" type="checkbox" id="stairs">
        <label class="form-check-label" for="stairs">Stairs</label>
      </div>
      <div class="col-auto">
        <input type="number" id="boardWidth" class="form-control" value="5.5" placeholder="Board Width (in)">
      </div>
      <div class="col-auto">
        <input type="number" id="boardLength" class="form-control" value="16" placeholder="Board Length (ft)">
      </div>
      <div class="col-auto">
        <input type="number" id="waste" class="form-control" value="10" placeholder="Waste (%)">
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-success">Calculate</button>
      </div>
      <div class="col-auto">
        <input class="form-check-input" type="checkbox" id="showBoards" checked>
        <label class="form-check-label" for="showBoards">Show Boards</label>
      </div>
    </form>
    <canvas id="deckCanvas" width="400" height="300" class="border mt-3"></canvas>
    <div class="mt-2">
      <button type="button" id="exportBtn" class="btn btn-secondary btn-sm">Export PNG</button>
      <button type="button" id="printBtn" class="btn btn-secondary btn-sm ms-1">Print</button>
    </div>
    <div id="calcResults" class="mt-3"></div>
  </div>

  <script>
    const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    const savedTheme = localStorage.getItem('deckchat_theme') || systemTheme;
    document.body.setAttribute('data-theme', savedTheme);

    document.getElementById('themeToggle')?.addEventListener('click', () => {
      const current = document.body.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', next);
      localStorage.setItem('deckchat_theme', next);
    });

    document.getElementById('styleSwitch')?.addEventListener('click', () => {
      const current = document.body.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', next);
      localStorage.setItem('deckchat_theme', next);
    });

    document.addEventListener('DOMContentLoaded', () => {
      const shapeSelect = document.getElementById('shape');
      function updateShapeFields() {
        const shape = shapeSelect.value;
        document.querySelectorAll('.shape-field').forEach(div => div.style.display = 'none');
        document.querySelectorAll('.shape-field.shape-' + shape).forEach(div => div.style.display = '');
        // Show/hide L-Shape fieldset
        const lshapeFieldset = document.querySelector('.lshape-dimensions');
        if (lshapeFieldset) {
          lshapeFieldset.style.display = (shape === 'lshape') ? '' : 'none';
        }
      }
      shapeSelect.addEventListener('change', updateShapeFields);
      updateShapeFields();

      const digitalizeBtn = document.getElementById('digitalizeBtn');
      if (digitalizeBtn && typeof uploadDrawing === 'function') {
        digitalizeBtn.addEventListener('click', uploadDrawing);
      }
    });

    function showSvgPreview(svgContent) {
      const svgContainer = document.getElementById('svgPreview');
      svgContainer.innerHTML = svgContent;
      const svg = svgContainer.querySelector('svg');
      if (svg) svg.classList.add('loaded');
    }
  </script>
  <script src="script.js" defer></script>
</body>
</html>
